<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planillaje Vehicular</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; background:#f4f6f9; }
h2 { text-align:center; }
input, select, button {
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:6px;
  border:1px solid #ccc;
}
button {
  background:#1e88e5;
  color:white;
  border:none;
  font-weight:bold;
}
button:hover { opacity:0.9; }
table {
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
}
th, td {
  border:1px solid #ccc;
  padding:5px;
  font-size:12px;
}
th { background:#e3e3e3; }
#cerrarBtn { background:red; margin-top:20px; }
</style>
</head>

<body>

<h2>Registro Vehicular Empresa</h2>

<h3>Inicio de Turno</h3>

<select id="conjunto">
<option value="">Seleccione Conjunto</option>
<option>San Rafael</option>
<option>Virrey</option>
<option>Quintas del Portal</option>
<option>Bosques</option>
<option>Corinto</option>
<option>Nueva Castilla</option>
<option>Torrecampo</option>
<option>Faisanes</option>
<option>Casas 3</option>
<option>Alameda</option>
<option>Brisas y Fortaleza</option>
</select>

<select id="turno">
<option value="">Seleccione Turno</option>
<option>Día</option>
<option>Noche</option>
</select>

<input type="text" id="guarda" placeholder="Nombre del Guarda">

<button onclick="iniciarTurno()">Iniciar Turno</button>

<hr>

<h3>Registrar Vehículo</h3>

<input type="text" id="placa" placeholder="Placa">
<input type="text" id="propietario" placeholder="Propietario">
<input type="text" id="telefono" placeholder="Teléfono">
<input type="text" id="torre" placeholder="Torre">
<input type="text" id="apartamento" placeholder="Apartamento">
<input type="text" id="parqueadero" placeholder="Parqueadero">

<select id="visitante">
<option>No</option>
<option>Sí</option>
</select>

<input type="text" id="novedades" placeholder="Novedades">

<button onclick="registrarIngreso()">Registrar Ingreso</button>

<table id="tabla">
<thead>
<tr>
<th>Placa</th>
<th>Propietario</th>
<th>Teléfono</th>
<th>Torre</th>
<th>Apartamento</th>
<th>Parqueadero</th>
<th>Visitante</th>
<th>Ingreso</th>
<th>Novedades</th>
</tr>
</thead>
<tbody></tbody>
</table>

<button id="cerrarBtn" onclick="cerrarTurno()">
Cerrar Turno y Descargar Planillaje
</button>

<script>
let registros = [];
let turnoActivo = false;
let datosTurno = {};

function iniciarTurno(){
  const conjunto = document.getElementById("conjunto").value;
  const turno = document.getElementById("turno").value;
  const guarda = document.getElementById("guarda").value;

  if(!conjunto || !turno || !guarda){
    alert("Complete todos los datos del turno");
    return;
  }

  datosTurno = {
    conjunto,
    turno,
    guarda,
    fecha: new Date().toLocaleDateString(),
    inicioTurno: new Date().toLocaleTimeString()
  };

  turnoActivo = true;
  alert("Turno iniciado correctamente");
}

function registrarIngreso(){
  if(!turnoActivo){
    alert("Debe iniciar turno primero");
    return;
  }

  const placa = document.getElementById("placa").value;
  if(!placa){
    alert("Ingrese la placa");
    return;
  }

  const registro = {
    placa,
    propietario: document.getElementById("propietario").value,
    telefono: document.getElementById("telefono").value,
    torre: document.getElementById("torre").value,
    apartamento: document.getElementById("apartamento").value,
    parqueadero: document.getElementById("parqueadero").value,
    visitante: document.getElementById("visitante").value,
    ingreso: new Date().toLocaleTimeString(),
    novedades: document.getElementById("novedades").value
  };

  registros.push(registro);
  actualizarTabla();

  document.getElementById("placa").value="";
  document.getElementById("propietario").value="";
  document.getElementById("telefono").value="";
  document.getElementById("torre").value="";
  document.getElementById("apartamento").value="";
  document.getElementById("parqueadero").value="";
  document.getElementById("novedades").value="";
}

function actualizarTabla(){
  const tbody = document.querySelector("#tabla tbody");
  tbody.innerHTML="";

  registros.forEach(r=>{
    const fila = `
      <tr>
        <td>${r.placa}</td>
        <td>${r.propietario}</td>
        <td>${r.telefono}</td>
        <td>${r.torre}</td>
        <td>${r.apartamento}</td>
        <td>${r.parqueadero}</td>
        <td>${r.visitante}</td>
        <td>${r.ingreso}</td>
        <td>${r.novedades}</td>
      </tr>
    `;
    tbody.innerHTML += fila;
  });
}

function cerrarTurno(){
  if(registros.length === 0){
    alert("No hay vehículos registrados.");
    return;
  }

  const fechaActual = new Date();
  const fecha = fechaActual.toLocaleDateString();

  const datosExcel = registros.map(r => ({
    Conjunto: datosTurno.conjunto,
    Fecha: fecha,
    Turno: datosTurno.turno,
    Guarda: datosTurno.guarda,
    Placa: r.placa,
    Propietario: r.propietario,
    Telefono: r.telefono,
    Torre: r.torre,
    Apartamento: r.apartamento,
    Parqueadero: r.parqueadero,
    Visitante: r.visitante,
    Hora_Ingreso: r.ingreso,
    Novedades: r.novedades
  }));

  const ws = XLSX.utils.json_to_sheet(datosExcel);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Planillaje");

  const nombreArchivo = `Planillaje_${datosTurno.conjunto}_${fecha}_${datosTurno.turno}.xlsx`;

  XLSX.writeFile(wb, nombreArchivo);

  alert("Planillaje descargado correctamente. Envíelo por WhatsApp.");

  registros = [];
  actualizarTabla();
  turnoActivo = false;
}
</script>

</body>
</html>
